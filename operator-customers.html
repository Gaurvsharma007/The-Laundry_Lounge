<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Laundry service operator dashboard for managing customers">
    <meta name="theme-color" content="#3dbdbd">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons and CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="simple-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <title>Customer Management | The Laundry Lounge</title>
    
    <style>
        :root {
            /* Colors */
            --primary: #3dbdbd;
            --primary-dark: #2a9d9d;
            --primary-light: #c5f1f1;
            --secondary: #ff6b6b;
            --accent: #ffd166;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --info: #2196f3;
            
            /* Neutrals */
            --bg-light: #f7fafc;
            --bg-dark: #1a202c;
            --text-dark: #2d3748;
            --text-light: #a0aec0;
            --text-muted: #718096;
            --border-light: #e2e8f0;
            
            /* UI */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.05), 0 4px 6px -2px rgba(0,0,0,0.03);
            --shadow-hover: 0 20px 25px -5px rgba(0,0,0,0.05), 0 10px 10px -5px rgba(0,0,0,0.02);
            
            --border-radius-sm: 0.375rem;
            --border-radius: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;
            
            --transition: all 0.3s ease;
            --transition-slow: all 0.5s ease;
        }
        
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.5;
            overflow-x: hidden;
            display: flex;
            min-height: 100vh;
        }
        
        /* Layout Styles */
        .dash-container {
            display: flex;
            width: 100%;
            min-height: 100vh;
        }
        
        .dash-sidebar {
            width: 260px;
            background: white;
            box-shadow: var(--shadow-md);
            z-index: 10;
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }
        
        .dash-sidebar-collapsed {
            transform: translateX(-220px);
        }
        
        .dash-main {
            flex: 1;
            margin-left: 260px;
            transition: margin 0.3s ease;
            padding: 2rem;
            background-color: var(--bg-light);
        }
        
        .dash-main-expanded {
            margin-left: 40px;
        }
        
        /* Sidebar Styles */
        .sidebar-header {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-light);
        }
        
        .sidebar-logo {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sidebar-collapse-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-light);
            color: var(--text-muted);
            cursor: pointer;
            margin-left: auto;
            transition: var(--transition);
            border: none;
        }
        
        .sidebar-collapse-btn:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }
        
        .sidebar-nav {
            padding: 1rem 0;
        }
        
        .sidebar-nav-item {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            color: var(--text-muted);
            text-decoration: none;
            transition: var(--transition);
            gap: 0.75rem;
            position: relative;
        }
        
        .sidebar-nav-item:hover {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }
        
        .sidebar-nav-item.active {
            background-color: var(--primary-light);
            color: var(--primary-dark);
            font-weight: 500;
        }
        
        .sidebar-nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: var(--primary);
        }
        
        .sidebar-nav-icon {
            width: 20px;
            text-align: center;
        }
        
        .sidebar-nav-label {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sidebar-nav-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 50px;
            font-size: 0.75rem;
            background-color: var(--primary-light);
            color: var(--primary-dark);
            font-weight: 600;
        }
        
        /* Dashboard Header */
        .dash-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        
        .dash-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .dash-subtitle {
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
        
        /* Customer Table Styles */
        .customer-table-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .customer-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .customer-table th,
        .customer-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }
        
        .customer-table th {
            background-color: var(--bg-light);
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .customer-table tbody tr:hover {
            background-color: var(--bg-light);
        }
        
        .customer-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .customer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-light);
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .customer-name {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .customer-info {
            color: var(--text-muted);
            font-size: 0.875rem;
        }
        
        .customer-action {
            color: var(--primary);
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .customer-action:hover {
            background-color: var(--primary-light);
        }
        
        .table-empty-state {
            padding: 3rem;
            text-align: center;
            color: var(--text-muted);
        }
        
        .table-empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--border-light);
        }
        
        .table-empty-state h3 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        /* Search and filter bar */
        .customer-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            gap: 1rem;
        }
        
        .search-container {
            position: relative;
            flex: 1;
            max-width: 400px;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
            font-size: 0.875rem;
            transition: var(--transition);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(61, 189, 189, 0.2);
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }
        
        /* Loading indicator */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(61, 189, 189, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .sync-button {
            background-color: var(--primary-light);
            color: var(--primary-dark);
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sync-button:hover {
            background-color: var(--primary);
            color: white;
        }
        
        .sync-button i {
            font-size: 0.875rem;
        }
        
        /* User Status Tabs */
        .user-status-tabs {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: 0.25rem;
            display: flex;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-light);
        }
        
        .status-tab {
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
            flex: 1;
            text-align: center;
            border: none;
            background: transparent;
            outline: none;
        }
        
        .status-tab:hover {
            color: var(--text-dark);
            background-color: var(--bg-light);
        }
        
        .status-tab.active {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .status-tab-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--primary-light);
            color: var(--primary-dark);
            font-size: 0.75rem;
            margin-left: 0.5rem;
            font-weight: 600;
            padding: 0 0.5rem;
        }
        
        /* User Status Indicators */
        .user-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .user-status.active {
            background-color: #ecfdf5;
            color: #065f46;
        }
        
        .user-status.inactive {
            background-color: #f3f4f6;
            color: #6b7280;
        }
        
        .user-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .user-status.active .status-dot {
            background-color: #10b981;
            box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        }
        
        .user-status.inactive .status-dot {
            background-color: #9ca3af;
        }
        
        /* Action buttons for user management */
        .user-action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .user-action {
            background: none;
            border: none;
            padding: 0.5rem;
            border-radius: 50%;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .user-action:hover {
            background-color: var(--primary-light);
            color: var(--primary-dark);
        }
        
        .user-action.delete-user {
            color: #ef4444;
        }
        
        .user-action.delete-user:hover {
            background-color: #fee2e2;
        }
        
        .user-action.force-logout {
            color: #f59e0b;
        }
        
        .user-action.force-logout:hover {
            background-color: #fef3c7;
        }
    </style>
</head>
<body>
    <div class="dash-container">
        <!-- Sidebar -->
        <div class="dash-sidebar" id="dashSidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-tshirt"></i>
                    <span>FreshThreads</span>
                </div>
                <button class="sidebar-collapse-btn" id="sidebarCollapseBtn">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            
            <div class="sidebar-nav">
                <a href="laundary.html" class="sidebar-nav-item">
                    <div class="sidebar-nav-icon"><i class="fas fa-home"></i></div>
                    <div class="sidebar-nav-label">Home</div>
                </a>
                
                <a href="operator-dashboard.html" class="sidebar-nav-item">
                    <div class="sidebar-nav-icon"><i class="fas fa-th-large"></i></div>
                    <div class="sidebar-nav-label">Dashboard</div>
                </a>
                
                <a href="neworder.html" class="sidebar-nav-item">
                    <div class="sidebar-nav-icon"><i class="fas fa-plus-circle"></i></div>
                    <div class="sidebar-nav-label">New Order</div>
                </a>
                
                <a href="#" class="sidebar-nav-item" id="navActiveOrders">
                    <div class="sidebar-nav-icon"><i class="fas fa-tasks"></i></div>
                    <div class="sidebar-nav-label">Active Orders</div>
                    <div class="sidebar-nav-badge" id="nav-active-count">0</div>
                </a>
                
                <a href="#" class="sidebar-nav-item" id="navCompletedOrders">
                    <div class="sidebar-nav-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="sidebar-nav-label">Completed</div>
                </a>
                
                <a href="trackorder.html" class="sidebar-nav-item">
                    <div class="sidebar-nav-icon"><i class="fas fa-search"></i></div>
                    <div class="sidebar-nav-label">Track Order</div>
                </a>
                
                <a href="#" class="sidebar-nav-item">
                    <div class="sidebar-nav-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="sidebar-nav-label">Reports</div>
                </a>
                
                <a href="operator-customers.html" class="sidebar-nav-item active">
                    <div class="sidebar-nav-icon"><i class="fas fa-users"></i></div>
                    <div class="sidebar-nav-label">Customers</div>
                </a>
                
                <a href="#" class="sidebar-nav-item">
                    <div class="sidebar-nav-icon"><i class="fas fa-cog"></i></div>
                    <div class="sidebar-nav-label">Settings</div>
                </a>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="dash-main" id="dashMain">
            <div class="dash-header">
                <div>
                    <h1 class="dash-title">Customer Management</h1>
                    <p class="dash-subtitle">View and manage all registered customers</p>
                </div>
                <div>
                    <button id="syncButton" class="sync-button">
                        <i class="fas fa-sync-alt"></i> Sync with Server
                    </button>
                </div>
            </div>
            
            <!-- User Status Tabs -->
            <div class="user-status-tabs">
                <button class="status-tab active" data-status="all">
                    All Users <span class="status-tab-badge" id="all-users-count">0</span>
                </button>
                <button class="status-tab" data-status="active">
                    Active (Logged In) <span class="status-tab-badge" id="active-users-count">0</span>
                </button>
                <button class="status-tab" data-status="inactive">
                    Inactive (Logged Out) <span class="status-tab-badge" id="inactive-users-count">0</span>
                </button>
            </div>
            
            <!-- Customer Controls -->
            <div class="customer-controls">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="customerSearch" class="search-input" placeholder="Search customers by name or email">
                </div>
            </div>
            
            <!-- Customer Table -->
            <div class="customer-table-container">
                <table class="customer-table" id="customerTable">
                    <thead>
                        <tr>
                            <th style="width: 60px;"></th>
                            <th>Customer</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Sign-Up Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customerTableBody">
                        <!-- Table content will be loaded dynamically -->
                    </tbody>
                </table>
                
                <!-- Loading Indicator -->
                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                    <p>Loading customers...</p>
                </div>
                
                <!-- Empty State -->
                <div class="table-empty-state" id="emptyState" style="display: none;">
                    <i class="fas fa-users"></i>
                    <h3>No customers found</h3>
                    <p>There are no customers registered in the system.</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Sidebar toggle functionality
            const sidebarCollapseBtn = document.getElementById('sidebarCollapseBtn');
            const dashSidebar = document.getElementById('dashSidebar');
            const dashMain = document.getElementById('dashMain');
            
            sidebarCollapseBtn.addEventListener('click', function() {
                dashSidebar.classList.toggle('dash-sidebar-collapsed');
                dashMain.classList.toggle('dash-main-expanded');
                
                // Change icon based on collapsed state
                if (dashSidebar.classList.contains('dash-sidebar-collapsed')) {
                    sidebarCollapseBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                } else {
                    sidebarCollapseBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                }
            });
            
            // Customer data loading
            const customerTableBody = document.getElementById('customerTableBody');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const emptyState = document.getElementById('emptyState');
            const customerSearch = document.getElementById('customerSearch');
            
            let allCustomers = [];
            let currentFilter = 'all';
            
            // Add status tab functionality
            const statusTabs = document.querySelectorAll('.status-tab');
            statusTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    statusTabs.forEach(t => t.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Set current filter
                    currentFilter = this.getAttribute('data-status');
                    
                    // Filter and display customers based on status
                    filterAndDisplayCustomers();
                });
            });
            
            // Function to filter and display customers
            function filterAndDisplayCustomers() {
                let filteredCustomers = [];
                
                switch(currentFilter) {
                    case 'active':
                        filteredCustomers = allCustomers.filter(customer => isUserLoggedIn(customer));
                        break;
                    case 'inactive':
                        filteredCustomers = allCustomers.filter(customer => !isUserLoggedIn(customer));
                        break;
                    default:
                        filteredCustomers = allCustomers;
                }
                
                // Also apply the search filter if there's a search term
                const searchTerm = customerSearch.value.toLowerCase();
                if (searchTerm) {
                    filteredCustomers = filteredCustomers.filter(customer => {
                        const fullName = `${customer.firstName} ${customer.lastName}`.toLowerCase();
                        const email = (customer.email || '').toLowerCase();
                        
                        return fullName.includes(searchTerm) || email.includes(searchTerm);
                    });
                }
                
                displayCustomersWithStatus(filteredCustomers);
            }
            
            // Function to check if a user is currently logged in
            function isUserLoggedIn(user) {
                try {
                    // Check if there's an active session for this user in localStorage
                    const allSessions = getAllActiveSessions();
                    return allSessions.some(session => session.user && session.user.id === user.id);
                } catch (error) {
                    console.error("Error checking user login status:", error);
                    return false;
                }
            }
            
            // Function to get all active sessions from localStorage
            function getAllActiveSessions() {
                try {
                    const sessions = [];
                    
                    // Look for session data in localStorage
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key === 'userSession') {
                            // Main user session
                            try {
                                const sessionData = JSON.parse(localStorage.getItem(key));
                                if (sessionData && sessionData.user) {
                                    sessions.push(sessionData);
                                }
                            } catch (e) {
                                console.error("Error parsing session:", e);
                            }
                        }
                    }
                    
                    return sessions;
                } catch (error) {
                    console.error("Error getting active sessions:", error);
                    return [];
                }
            }
            
            // Modify the display customers function to include login status
            function displayCustomersWithStatus(customers) {
                loadingSpinner.style.display = 'none';
                
                if (!customers || customers.length === 0) {
                    showEmptyState();
                    return;
                }
                
                emptyState.style.display = 'none';
                customerTableBody.innerHTML = '';
                
                // Update counts
                document.getElementById('all-users-count').textContent = allCustomers.length;
                document.getElementById('active-users-count').textContent = 
                    allCustomers.filter(customer => isUserLoggedIn(customer)).length;
                document.getElementById('inactive-users-count').textContent = 
                    allCustomers.filter(customer => !isUserLoggedIn(customer)).length;
                
                customers.forEach(customer => {
                    // Skip password field if present
                    const { password, ...displayCustomer } = customer;
                    
                    // Create initials for avatar
                    const initials = (customer.firstName?.charAt(0) || '') + (customer.lastName?.charAt(0) || '');
                    
                    // Format date
                    const signupDate = customer.createdAt ? new Date(customer.createdAt).toLocaleDateString() : 'N/A';
                    
                    // Determine if user is logged in
                    const isLoggedIn = isUserLoggedIn(customer);
                    const statusClass = isLoggedIn ? 'active' : 'inactive';
                    const statusText = isLoggedIn ? 'Active' : 'Inactive';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="customer-avatar">${initials}</div>
                        </td>
                        <td>
                            <div class="customer-name">${customer.firstName || ''} ${customer.lastName || ''}</div>
                        </td>
                        <td>${customer.email || 'N/A'}</td>
                        <td>${customer.phone || 'N/A'}</td>
                        <td>${signupDate}</td>
                        <td>
                            <div class="user-status ${statusClass}">
                                <span class="status-dot"></span>
                                ${statusText}
                            </div>
                        </td>
                        <td>
                            <div class="user-action-buttons">
                                <button class="user-action" data-customer-id="${customer.id || ''}" title="View details">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                ${isLoggedIn ? `
                                <button class="user-action force-logout" data-customer-id="${customer.id || ''}" title="Force logout">
                                    <i class="fas fa-sign-out-alt"></i>
                                </button>` : ''}
                                <button class="user-action delete-user" data-customer-id="${customer.id || ''}" title="Delete user">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    customerTableBody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                document.querySelectorAll('.user-action').forEach(button => {
                    if (button.classList.contains('delete-user')) {
                        button.addEventListener('click', function() {
                            const customerId = this.getAttribute('data-customer-id');
                            deleteUser(customerId);
                        });
                    } else if (button.classList.contains('force-logout')) {
                        button.addEventListener('click', function() {
                            const customerId = this.getAttribute('data-customer-id');
                            forceLogout(customerId);
                        });
                    } else {
                        button.addEventListener('click', function() {
                            const customerId = this.getAttribute('data-customer-id');
                            const customer = allCustomers.find(c => c.id === customerId);
                            
                            if (customer) {
                                viewCustomerDetails(customer);
                            }
                        });
                    }
                });
            }
            
            // Function to delete a user
            function deleteUser(userId) {
                const user = allCustomers.find(c => c.id === userId);
                
                if (!user) return;
                
                Swal.fire({
                    title: 'Delete User',
                    html: `Are you sure you want to delete <strong>${user.firstName} ${user.lastName}</strong>?<br>This action cannot be undone.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#ef4444',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Yes, delete user',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Try to delete from SimpleAuth
                        if (typeof SimpleAuth !== 'undefined' && SimpleAuth.deleteUser) {
                            const success = SimpleAuth.deleteUser(userId);
                            
                            if (success) {
                                // Remove from our local array
                                allCustomers = allCustomers.filter(c => c.id !== userId);
                                
                                // Refresh the display
                                filterAndDisplayCustomers();
                                
                                Swal.fire({
                                    title: 'Deleted!',
                                    text: 'User has been deleted.',
                                    icon: 'success',
                                    confirmButtonColor: '#3dbdbd'
                                });
                            } else {
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Failed to delete user. Please try again.',
                                    icon: 'error',
                                    confirmButtonColor: '#3dbdbd'
                                });
                            }
                        } else {
                            // Try server API
                            fetch(`/api/users/${userId}`, {
                                method: 'DELETE'
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Remove from our local array
                                    allCustomers = allCustomers.filter(c => c.id !== userId);
                                    
                                    // Refresh the display
                                    filterAndDisplayCustomers();
                                    
                                    Swal.fire({
                                        title: 'Deleted!',
                                        text: 'User has been deleted.',
                                        icon: 'success',
                                        confirmButtonColor: '#3dbdbd'
                                    });
                                } else {
                                    throw new Error(data.message || 'Failed to delete user');
                                }
                            })
                            .catch(error => {
                                console.error('Error deleting user:', error);
                                Swal.fire({
                                    title: 'Error',
                                    text: error.message || 'Failed to delete user. Please try again.',
                                    icon: 'error',
                                    confirmButtonColor: '#3dbdbd'
                                });
                            });
                        }
                    }
                });
            }
            
            // Function to force logout a user
            function forceLogout(userId) {
                const user = allCustomers.find(c => c.id === userId);
                
                if (!user) return;
                
                Swal.fire({
                    title: 'Force Logout',
                    html: `Are you sure you want to force logout <strong>${user.firstName} ${user.lastName}</strong>?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3dbdbd',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Yes, logout user',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // For SimpleAuth we would need to remove the user's session from localStorage
                        let success = false;
                        
                        try {
                            // Get the session
                            const sessionData = localStorage.getItem('userSession');
                            if (sessionData) {
                                const session = JSON.parse(sessionData);
                                if (session.user && session.user.id === userId) {
                                    localStorage.removeItem('userSession');
                                    success = true;
                                }
                            }
                            
                            if (success) {
                                Swal.fire({
                                    title: 'Success',
                                    text: 'User has been logged out.',
                                    icon: 'success',
                                    confirmButtonColor: '#3dbdbd'
                                }).then(() => {
                                    // Refresh to show updated status
                                    filterAndDisplayCustomers();
                                });
                            } else {
                                Swal.fire({
                                    title: 'Not Found',
                                    text: 'Could not find an active session for this user.',
                                    icon: 'info',
                                    confirmButtonColor: '#3dbdbd'
                                });
                            }
                        } catch (error) {
                            console.error('Error forcing logout:', error);
                            Swal.fire({
                                title: 'Error',
                                text: 'Failed to force logout. ' + error.message,
                                icon: 'error',
                                confirmButtonColor: '#3dbdbd'
                            });
                        }
                    }
                });
            }
            
            // Modify loadCustomers function
            function loadCustomers() {
                loadingSpinner.style.display = 'block';
                emptyState.style.display = 'none';
                customerTableBody.innerHTML = '';
                
                // Try to get customers from SimpleAuth
                if (typeof SimpleAuth !== 'undefined') {
                    try {
                        // Get all users from local storage
                        const users = SimpleAuth.getAllUsers ? SimpleAuth.getAllUsers() : [];
                        allCustomers = users;
                        filterAndDisplayCustomers();
                    } catch (error) {
                        console.error("Error loading customers from SimpleAuth:", error);
                        fallbackToServerAPI();
                    }
                } else {
                    fallbackToServerAPI();
                }
            }
            
            // Update search functionality
            customerSearch.addEventListener('input', function() {
                filterAndDisplayCustomers();
            });
            
            // Fallback to server API if SimpleAuth is not available
            function fallbackToServerAPI() {
                // Try to fetch users from server API
                fetch('/api/users')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            displayCustomers(data.users);
                        } else {
                            showEmptyState();
                        }
                    })
                    .catch(error => {
                        console.error("Error fetching customers from API:", error);
                        showEmptyState();
                    });
            }
            
            // View customer details
            function viewCustomerDetails(customer) {
                // Remove password for security
                const { password, ...safeCustomer } = customer;
                
                Swal.fire({
                    title: `${customer.firstName} ${customer.lastName}`,
                    html: `
                        <div style="text-align: left; margin-top: 1rem;">
                            <p><strong>Email:</strong> ${customer.email}</p>
                            <p><strong>Phone:</strong> ${customer.phone}</p>
                            <p><strong>ID:</strong> ${customer.id}</p>
                            <p><strong>Signed Up:</strong> ${new Date(customer.createdAt).toLocaleString()}</p>
                        </div>
                    `,
                    icon: 'info',
                    confirmButtonColor: '#3dbdbd'
                });
            }
            
            // Show empty state
            function showEmptyState() {
                loadingSpinner.style.display = 'none';
                customerTableBody.innerHTML = '';
                emptyState.style.display = 'block';
            }
            
            // Add getAllUsers function to SimpleAuth if it doesn't exist
            if (typeof SimpleAuth !== 'undefined' && !SimpleAuth.getAllUsers) {
                SimpleAuth.getAllUsers = function() {
                    try {
                        const usersJson = localStorage.getItem('laundryUsers');
                        return usersJson ? JSON.parse(usersJson) : [];
                    } catch (error) {
                        console.error("Error getting all users:", error);
                        return [];
                    }
                };
            }
            
            // Sync users from localStorage to server
            document.getElementById('syncButton').addEventListener('click', function() {
                if (typeof SimpleAuth !== 'undefined' && SimpleAuth.getAllUsers) {
                    const users = SimpleAuth.getAllUsers();
                    
                    if (!users || users.length === 0) {
                        Swal.fire({
                            title: 'No Users to Sync',
                            text: 'There are no users in the local storage to sync with the server.',
                            icon: 'info',
                            confirmButtonColor: '#3dbdbd'
                        });
                        return;
                    }
                    
                    // Show confirmation
                    Swal.fire({
                        title: 'Sync Users',
                        text: `This will sync ${users.length} users to the server database. Continue?`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonColor: '#3dbdbd',
                        confirmButtonText: 'Yes, sync users'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            // Show loading
                            Swal.fire({
                                title: 'Syncing...',
                                text: 'Syncing users to server database',
                                allowOutsideClick: false,
                                showConfirmButton: false,
                                willOpen: () => {
                                    Swal.showLoading();
                                }
                            });
                            
                            // Send users to server
                            fetch('/api/users/sync', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ users: users })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    Swal.fire({
                                        title: 'Sync Complete',
                                        text: data.message || 'Users have been synced to the server database.',
                                        icon: 'success',
                                        confirmButtonColor: '#3dbdbd'
                                    });
                                    
                                    // Reload customers
                                    loadCustomers();
                                } else {
                                    Swal.fire({
                                        title: 'Sync Failed',
                                        text: data.message || 'Failed to sync users to server.',
                                        icon: 'error',
                                        confirmButtonColor: '#3dbdbd'
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('Error syncing users:', error);
                                Swal.fire({
                                    title: 'Sync Failed',
                                    text: 'An error occurred while syncing users to server.',
                                    icon: 'error',
                                    confirmButtonColor: '#3dbdbd'
                                });
                            });
                        }
                    });
                } else {
                    Swal.fire({
                        title: 'Not Available',
                        text: 'SimpleAuth is not available to sync users.',
                        icon: 'warning',
                        confirmButtonColor: '#3dbdbd'
                    });
                }
            });
            
            // Initial load
            loadCustomers();
        });
    </script>
</body>
</html> 