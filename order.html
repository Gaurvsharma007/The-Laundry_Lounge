<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Order - Laundry Service</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #3498db;
        }
        .navbar-brand, .nav-link {
            color: white !important;
        }
        .order-form-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .form-section:last-child {
            border-bottom: none;
        }
        .service-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .service-item .form-check-input {
            margin-top: 8px;
        }
        .service-item .form-control {
            max-width: 80px;
        }
        .btn-primary {
            background-color: #3498db;
            border-color: #3498db;
            padding: 10px 25px;
        }
        .btn-primary:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        .section-title {
            margin-bottom: 20px;
            color: #2c3e50;
        }
        .service-name {
            font-weight: 600;
        }
        .service-price {
            color: #2c3e50;
            font-weight: 500;
        }
        .service-description {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        #orderSummary {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .total-row {
            font-weight: bold;
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
            font-size: 1.1em;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="laundary.html">
                <i class="fas fa-tshirt me-2"></i>Laundry Service
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="laundary.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="order.html">New Order</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="trackorder.html">Track Order</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Order Form -->
    <div class="container">
        <div class="order-form-container">
            <h2 class="text-center mb-4">Place a New Laundry Order</h2>
            
            <form id="orderForm">
                <!-- Customer Information Section -->
                <div class="form-section">
                    <h4 class="section-title"><i class="fas fa-user me-2"></i>Customer Information</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customerName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="customerName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="customerPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="customerPhone" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="customerAddress" class="form-label">Address</label>
                        <textarea class="form-control" id="customerAddress" rows="2" required></textarea>
                    </div>
                </div>
                
                <!-- Laundry Services Section -->
                <div class="form-section">
                    <h4 class="section-title"><i class="fas fa-soap me-2"></i>Select Services</h4>
                    <p class="text-muted mb-3">Choose the services you need and specify the quantity for each selected service.</p>
                    
                    <div id="servicesContainer">
                        <!-- Service items will be added here dynamically -->
                    </div>
                </div>
                
                <!-- Pickup Information Section -->
                <div class="form-section">
                    <h4 class="section-title"><i class="fas fa-truck me-2"></i>Pickup Information</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="pickupDate" class="form-label">Pickup Date</label>
                            <input type="date" class="form-control" id="pickupDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="pickupTime" class="form-label">Preferred Time</label>
                            <select class="form-control" id="pickupTime" required>
                                <option value="">Select time slot</option>
                                <option value="9am-12pm">Morning (9AM - 12PM)</option>
                                <option value="12pm-3pm">Afternoon (12PM - 3PM)</option>
                                <option value="3pm-6pm">Evening (3PM - 6PM)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="specialInstructions" class="form-label">Special Instructions (Optional)</label>
                        <textarea class="form-control" id="specialInstructions" rows="2"></textarea>
                    </div>
                </div>
                
                <!-- Order Summary Section -->
                <div class="form-section">
                    <h4 class="section-title"><i class="fas fa-receipt me-2"></i>Order Summary</h4>
                    <div id="orderSummary">
                        <p class="text-muted text-center" id="emptySummary">Select services to see your order summary</p>
                        <div id="summaryItems" class="d-none">
                            <!-- Summary items will be added here dynamically -->
                            <div class="summary-item total-row">
                                <span>Total Amount</span>
                                <span id="totalAmount">$0.00</span>
                            </div>
                            <div class="text-muted mt-3 small">
                                <p>Expected delivery: <span id="expectedDelivery">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Submit Button -->
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-check-circle me-2"></i>Place Order
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Order Placed Successfully!</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">Thank You for Your Order</h4>
                    <p>Your order has been placed successfully.</p>
                    <p class="mb-0">Your Order ID: <strong id="generatedOrderId"></strong></p>
                    <p class="text-muted small">Please save this ID for tracking your order.</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <a href="trackorder.html" id="trackOrderLink" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Track Your Order
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Wash & Fold Items Modal -->
    <div class="modal fade" id="washFoldModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Wash & Fold - Select Items</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">Please select the items you want to include in your Wash & Fold service:</p>
                    <div class="row row-cols-1 row-cols-md-3 g-3" id="washFoldItems">
                        <!-- Items will be added here dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveWashFoldItems">
                        <i class="fas fa-save me-1"></i> Save Selection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="orders.js"></script>
    
    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        // LaundryPopup React Component
        const LaundryPopup = ({ isOpen, onClose, onDone }) => {
            const [items, setItems] = React.useState({
                'Blanket': 0,
                'Bed Sheet': 0,
                'Pillow Cover': 0,
                'Shorts': 0,
                'Nikkar': 0,
                'Lower': 0,
                'Civil Shirt': 0,
                'School T-Shirt': 0,
                'Jeans': 0,
                'School Pant': 0,
                'Sweater': 0,
                'Shoes': 0,
                'Civil T-Shirt': 0,
                'Jacket': 0,
                'Coat': 0
            });

            const handleIncrement = (itemName) => {
                setItems({
                    ...items,
                    [itemName]: items[itemName] + 1
                });
            };

            const handleDecrement = (itemName) => {
                if (items[itemName] > 0) {
                    setItems({
                        ...items,
                        [itemName]: items[itemName] - 1
                    });
                }
            };

            const totalItems = Object.values(items).reduce((sum, count) => sum + count, 0);

            return (
                <div className={`modal-overlay ${isOpen ? '' : 'hidden'}`} style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    backgroundColor: 'rgba(0, 0, 0, 0.5)',
                    display: isOpen ? 'flex' : 'none',
                    justifyContent: 'center',
                    alignItems: 'center',
                    zIndex: 1050
                }}>
                    <div className="laundry-popup" style={{
                        backgroundColor: 'white',
                        borderRadius: '12px',
                        width: '90%',
                        maxWidth: '800px',
                        maxHeight: '90vh',
                        overflowY: 'auto',
                        boxShadow: '0 5px 15px rgba(0,0,0,0.3)'
                    }}>
                        <div className="laundry-popup-header" style={{
                            padding: '20px',
                            borderBottom: '1px solid #eee',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center'
                        }}>
                            <h3 style={{ margin: 0 }}>
                                <i className="fas fa-tshirt" style={{ marginRight: '10px', color: '#3498db' }}></i>
                                Select Wash & Fold Items
                            </h3>
                            <button onClick={onClose} style={{
                                background: 'none',
                                border: 'none',
                                fontSize: '24px',
                                cursor: 'pointer'
                            }}>&times;</button>
                        </div>
                        
                        <div style={{ padding: '20px' }}>
                            <p style={{ marginBottom: '20px' }}>
                                Please specify the quantity for each item you're including in your wash & fold service:
                            </p>
                            
                            <div style={{
                                display: 'grid',
                                gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))',
                                gap: '15px',
                                marginBottom: '30px'
                            }}>
                                {Object.keys(items).map(itemName => (
                                    <div key={itemName} style={{
                                        backgroundColor: '#f8f9fa',
                                        borderRadius: '8px',
                                        padding: '15px',
                                        display: 'flex',
                                        flexDirection: 'column',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.05)'
                                    }}>
                                        <div style={{ fontWeight: 600, marginBottom: '10px' }}>{itemName}</div>
                                        <div style={{
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'space-between'
                                        }}>
                                            <button onClick={() => handleDecrement(itemName)} style={{
                                                width: '30px',
                                                height: '30px',
                                                borderRadius: '50%',
                                                border: '1px solid #ddd',
                                                background: 'white',
                                                cursor: 'pointer'
                                            }}>-</button>
                                            
                                            <span style={{ fontWeight: 600 }}>{items[itemName]}</span>
                                            
                                            <button onClick={() => handleIncrement(itemName)} style={{
                                                width: '30px',
                                                height: '30px',
                                                borderRadius: '50%',
                                                border: '1px solid #ddd',
                                                background: 'white',
                                                cursor: 'pointer'
                                            }}>+</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            
                            <div style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                marginTop: '20px',
                                paddingTop: '20px',
                                borderTop: '1px solid #eee'
                            }}>
                                <div>
                                    <strong>Total items: </strong> 
                                    <span style={{ 
                                        display: 'inline-block',
                                        padding: '5px 15px',
                                        borderRadius: '20px',
                                        backgroundColor: '#3498db',
                                        color: 'white',
                                        fontWeight: 600,
                                        marginLeft: '10px'
                                    }}>{totalItems}</span>
                                </div>
                                
                                <div>
                                    <button onClick={onClose} style={{
                                        padding: '10px 20px',
                                        borderRadius: '30px',
                                        border: '1px solid #ddd',
                                        background: 'white',
                                        marginRight: '10px',
                                        cursor: 'pointer'
                                    }}>Cancel</button>
                                    
                                    <button onClick={() => onDone(items)} style={{
                                        padding: '10px 20px',
                                        borderRadius: '30px',
                                        border: 'none',
                                        background: '#3498db',
                                        color: 'white',
                                        fontWeight: 600,
                                        cursor: 'pointer'
                                    }}>Save Selection</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Create a controller to manage the popup state
        window.LaundryPopupController = {
            isOpen: false,
            items: {},
            open: function() {
                this.isOpen = true;
                this.render();
                console.log('LaundryPopupController.open called, isOpen =', this.isOpen);
            },
            close: function() {
                this.isOpen = false;
                this.render();
            },
            handleDone: function(items) {
                // Store the selected items
                this.items = items;
                
                // Calculate total items
                const totalItems = Object.values(items).reduce((sum, count) => sum + count, 0);
                
                // Get the wash-fold quantity input by its ID
                const quantityInput = document.getElementById('wash-fold-quantity');
                
                if (quantityInput) {
                    // Update the value and trigger a change event
                    quantityInput.value = totalItems > 0 ? totalItems : 1;
                    quantityInput.dispatchEvent(new Event('change')); // Trigger change event
                } else {
                    console.log('Could not find wash-fold-quantity input, trying alternate selectors');
                    
                    // Try alternate selectors as fallbacks
                    const alternateInput = document.querySelector('.service-quantity[data-service-id="wash-fold"]');
                    if (alternateInput) {
                        alternateInput.value = totalItems > 0 ? totalItems : 1;
                        alternateInput.dispatchEvent(new Event('change'));
                        console.log('Updated quantity with alternate selector');
                    } else {
                        console.warn('Could not find wash-fold quantity input with any selector');
                    }
                }
                
                // Close the popup
                this.close();
            },
            render: function() {
                const root = document.getElementById('laundry-popup-root');
                if (!root) return;
                
                ReactDOM.render(
                    <LaundryPopup
                        isOpen={this.isOpen}
                        onClose={() => this.close()}
                        onDone={(items) => this.handleDone(items)}
                    />,
                    root
                );
            },
            init: function() {
                this.render();
                
                // No need to add a duplicate event listener here
                // since we're handling it in setupEventListeners
            }
        };

        // Initialize the popup controller when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            window.LaundryPopupController.init();
        });
    </script>
    
    <!-- Add this new div for React to render the popup -->
    <div id="laundry-popup-root"></div>
    
    <script>
        // Services data
        const laundryServices = [
            {
                id: 'wash-fold',
                name: 'Wash & Fold',
                price: 2.50,
                unit: 'per lb',
                description: 'Regular washing and folding service for everyday clothing'
            },
            {
                id: 'dry-cleaning',
                name: 'Dry Cleaning',
                price: 6.00,
                unit: 'per item',
                description: 'Specialized cleaning for delicate fabrics and formal wear'
            },
            {
                id: 'ironing',
                name: 'Ironing Service',
                price: 3.00,
                unit: 'per item',
                description: 'Professional ironing for wrinkle-free garments'
            },
            {
                id: 'bedding',
                name: 'Bedding & Linens',
                price: 15.00,
                unit: 'per set',
                description: 'Cleaning for bed sheets, pillowcases, and other linens'
            },
            {
                id: 'stain-removal',
                name: 'Stain Removal',
                price: 8.00,
                unit: 'per stain',
                description: 'Special treatment for tough stains and spots'
            },
            {
                id: 'express',
                name: 'Express Service',
                price: 10.00,
                unit: 'surcharge',
                description: 'Same-day service with priority handling (add-on)'
            }
        ];

        // Wash & Fold items data
        const washFoldItems = [
            { id: 'blanket', name: 'Blanket', icon: 'fa-solid fa-blanket' },
            { id: 'bed-sheet', name: 'Bed Sheet', icon: 'fa-solid fa-bed' },
            { id: 'pillow-cover', name: 'Pillow Cover', icon: 'fa-solid fa-pillow' },
            { id: 'shorts', name: 'Shorts', icon: 'fa-solid fa-shorts' },
            { id: 'nikkar', name: 'Nikkar', icon: 'fa-solid fa-tshirt' },
            { id: 'lower', name: 'Lower', icon: 'fa-solid fa-socks' },
            { id: 'civil-shirt', name: 'Civil Shirt', icon: 'fa-solid fa-shirt' },
            { id: 'school-tshirt', name: 'School T-Shirt', icon: 'fa-solid fa-tshirt' },
            { id: 'jeans', name: 'Jeans', icon: 'fa-solid fa-socks' },
            { id: 'school-pant', name: 'School Pant', icon: 'fa-solid fa-socks' },
            { id: 'sweater', name: 'Sweater', icon: 'fa-solid fa-shirt' },
            { id: 'shoes', name: 'Shoes', icon: 'fa-solid fa-shoe-prints' },
            { id: 'civil-tshirt', name: 'Civil T-Shirt', icon: 'fa-solid fa-tshirt' },
            { id: 'jacket', name: 'Jacket', icon: 'fa-solid fa-vest' },
            { id: 'coat', name: 'Coat', icon: 'fa-solid fa-vest-patches' }
        ];

        // DOM Elements
        const servicesContainer = document.getElementById('servicesContainer');
        const orderForm = document.getElementById('orderForm');
        const orderSummary = document.getElementById('orderSummary');
        const emptySummary = document.getElementById('emptySummary');
        const summaryItems = document.getElementById('summaryItems');
        const totalAmountElement = document.getElementById('totalAmount');
        const expectedDeliveryElement = document.getElementById('expectedDelivery');
        const orderSuccessModal = new bootstrap.Modal(document.getElementById('orderSuccessModal'));
        const generatedOrderIdElement = document.getElementById('generatedOrderId');
        const trackOrderLinkElement = document.getElementById('trackOrderLink');
        const washFoldModal = new bootstrap.Modal(document.getElementById('washFoldModal'));
        const washFoldItemsContainer = document.getElementById('washFoldItems');
        const saveWashFoldItemsBtn = document.getElementById('saveWashFoldItems');
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set minimum date to today for pickup date
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            document.getElementById('pickupDate').min = dateString;
            
            // Populate services
            populateServices();
            
            // Populate Wash & Fold items
            populateWashFoldItems();
            
            // Setup event listeners
            setupEventListeners();
            
            // Add specific event listener for wash-fold checkbox
            const washFoldCheckbox = document.querySelector('.service-checkbox[data-service-id="wash-fold"]');
            if (washFoldCheckbox) {
                washFoldCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        washFoldModal.show();
                    }
                });
            }
        });
        
        // Populate services in the form
        function populateServices() {
            laundryServices.forEach(service => {
                const serviceItem = document.createElement('div');
                serviceItem.className = 'service-item';
                serviceItem.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col-md-1">
                            <input class="form-check-input service-checkbox" type="checkbox" 
                                   id="${service.id}" data-service-id="${service.id}">
                        </div>
                        <div class="col-md-7">
                            <label class="form-check-label" for="${service.id}">
                                <div class="service-name">${service.name}</div>
                                <div class="service-price">${OrderManager.formatCurrency(service.price)} ${service.unit}</div>
                                <div class="service-description">${service.description}</div>
                            </label>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                                <input type="number" class="form-control service-quantity" 
                                       id="${service.id}-quantity" min="1" value="1" disabled
                                       data-service-id="${service.id}">
                                <span class="input-group-text">
                                    ${service.unit.includes('per') ? service.unit.replace('per', '').trim() : 'items'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                servicesContainer.appendChild(serviceItem);
            });
        }
        
        // Populate Wash & Fold items in modal
        function populateWashFoldItems() {
            washFoldItems.forEach(item => {
                const itemCol = document.createElement('div');
                itemCol.className = 'col';
                itemCol.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <i class="${item.icon} me-2"></i>
                                <h6 class="card-title mb-0">${item.name}</h6>
                            </div>
                            <div class="input-group item-quantity">
                                <button class="btn btn-outline-secondary decrease-btn" type="button" data-item-id="${item.id}">-</button>
                                <input type="number" class="form-control text-center" value="0" min="0" data-item-id="${item.id}">
                                <button class="btn btn-outline-secondary increase-btn" type="button" data-item-id="${item.id}">+</button>
                            </div>
                        </div>
                    </div>
                `;
                washFoldItemsContainer.appendChild(itemCol);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Service checkboxes
            document.querySelectorAll('.service-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const serviceId = this.dataset.serviceId;
                    const quantityInput = document.getElementById(`${serviceId}-quantity`);
                    
                    if (this.checked) {
                        quantityInput.removeAttribute('disabled');
                        
                        // If this is Wash & Fold, show the React popup instead of Bootstrap modal
                        if (serviceId === 'wash-fold' && window.LaundryPopupController) {
                            setTimeout(() => {
                                window.LaundryPopupController.open();
                            }, 100);
                            
                            // Don't show Bootstrap modal
                            return;
                        }
                    } else {
                        quantityInput.setAttribute('disabled', 'disabled');
                    }
                    
                    updateOrderSummary();
                });
            });
            
            // Quantity inputs
            document.querySelectorAll('.service-quantity').forEach(input => {
                input.addEventListener('change', function() {
                    if (this.value < 1) this.value = 1;
                    updateOrderSummary();
                });
            });
            
            // Wash & Fold item quantity controls
            washFoldItemsContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('increase-btn')) {
                    const itemId = e.target.dataset.itemId;
                    const input = this.querySelector(`input[data-item-id="${itemId}"]`);
                    input.value = parseInt(input.value) + 1;
                } else if (e.target.classList.contains('decrease-btn')) {
                    const itemId = e.target.dataset.itemId;
                    const input = this.querySelector(`input[data-item-id="${itemId}"]`);
                    if (parseInt(input.value) > 0) {
                        input.value = parseInt(input.value) - 1;
                    }
                }
            });
            
            // Save Wash & Fold items
            saveWashFoldItemsBtn.addEventListener('click', function() {
                washFoldModal.hide();
            });
            
            // Pickup date
            document.getElementById('pickupDate').addEventListener('change', updateExpectedDelivery);
            
            // Form submission
            orderForm.addEventListener('submit', handleOrderSubmission);
        }
        
        // Update order summary
        function updateOrderSummary() {
            const selectedServices = getSelectedServices();
            
            if (selectedServices.length === 0) {
                emptySummary.classList.remove('d-none');
                summaryItems.classList.add('d-none');
                return;
            }
            
            emptySummary.classList.add('d-none');
            summaryItems.classList.remove('d-none');
            
            // Clear previous items except the total row
            const items = summaryItems.querySelectorAll('.summary-item:not(.total-row)');
            items.forEach(item => item.remove());
            
            // Calculate total and add items
            let total = 0;
            selectedServices.forEach(service => {
                const serviceData = laundryServices.find(s => s.id === service.id);
                const subtotal = serviceData.price * service.quantity;
                total += subtotal;
                
                const summaryItem = document.createElement('div');
                summaryItem.className = 'summary-item';
                summaryItem.innerHTML = `
                    <span>${serviceData.name} × ${service.quantity}</span>
                    <span>${OrderManager.formatCurrency(subtotal)}</span>
                `;
                
                summaryItems.insertBefore(summaryItem, summaryItems.firstChild);
            });
            
            // Update total
            totalAmountElement.textContent = OrderManager.formatCurrency(total);
            
            // Update expected delivery
            updateExpectedDelivery();
        }
        
        // Get selected services with quantities
        function getSelectedServices() {
            const selectedServices = [];
            
            document.querySelectorAll('.service-checkbox:checked').forEach(checkbox => {
                const serviceId = checkbox.dataset.serviceId;
                const quantityInput = document.getElementById(`${serviceId}-quantity`);
                const serviceData = laundryServices.find(s => s.id === serviceId);
                
                selectedServices.push({
                    id: serviceId,
                    name: serviceData.name,
                    price: serviceData.price,
                    quantity: parseInt(quantityInput.value),
                    unit: serviceData.unit
                });
            });
            
            return selectedServices;
        }
        
        // Update expected delivery date based on pickup date
        function updateExpectedDelivery() {
            const pickupDateInput = document.getElementById('pickupDate');
            
            if (pickupDateInput.value) {
                const pickupDate = new Date(pickupDateInput.value);
                const deliveryDate = OrderManager.calculateExpectedDelivery(pickupDate);
                expectedDeliveryElement.textContent = OrderManager.formatDate(deliveryDate);
            } else {
                expectedDeliveryElement.textContent = '-';
            }
        }
        
        // Handle order form submission
        function handleOrderSubmission(event) {
            event.preventDefault();
            
            // Validate if at least one service is selected
            const selectedServices = getSelectedServices();
            if (selectedServices.length === 0) {
                alert('Please select at least one service.');
                return;
            }
            
            // Collect form data
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const customerAddress = document.getElementById('customerAddress').value;
            const pickupDate = new Date(document.getElementById('pickupDate').value);
            const pickupTime = document.getElementById('pickupTime').value;
            const specialInstructions = document.getElementById('specialInstructions').value;
            
            // Calculate total amount
            let totalAmount = 0;
            selectedServices.forEach(service => {
                totalAmount += service.price * service.quantity;
            });
            
            // Process Wash & Fold items if they exist
            const washFoldIndex = selectedServices.findIndex(service => service.id === 'wash-fold');
            if (washFoldIndex !== -1 && window.LaundryPopupController) {
                // Get items from the LaundryPopupController
                const washFoldItems = window.LaundryPopupController.items;
                
                // Add the items to the service
                selectedServices[washFoldIndex].items = washFoldItems;
                
                // Log for debugging
                console.log('Including Wash & Fold items:', washFoldItems);
            }
            
            // Create order details object
            const orderDetails = {
                customer: {
                    name: customerName,
                    phone: customerPhone,
                    address: customerAddress
                },
                services: selectedServices,
                pickup: {
                    date: pickupDate,
                    timeSlot: pickupTime,
                    specialInstructions: specialInstructions
                },
                totalAmount: totalAmount,
                expectedDelivery: OrderManager.calculateExpectedDelivery(pickupDate)
            };
            
            // Log for debugging
            console.log('Creating order with details:', orderDetails);
            
            // Create the order and get order ID
            const orderId = OrderManager.createOrder(orderDetails);
            
            // Show success modal
            generatedOrderIdElement.textContent = orderId;
            trackOrderLinkElement.href = `trackorder.html?orderId=${orderId}`;
            orderSuccessModal.show();
            
            // Reset form
            orderForm.reset();
            document.querySelectorAll('.service-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('.service-quantity').forEach(input => {
                input.setAttribute('disabled', 'disabled');
            });
            
            // Reset wash & fold items if needed
            if (window.LaundryPopupController) {
                window.LaundryPopupController.items = {};
            }
            
            updateOrderSummary();
        }
    </script>
</body>
</html> 